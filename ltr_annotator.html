<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LTR –ê–Ω–Ω–æ—Ç–∞—Ç–æ—Ä - –†–∞–∑–º–µ—Ç–∫–∞ –¥–∞—Ç–∞—Å–µ—Ç–∞</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .progress-bar {
            background: #e0e0e0;
            height: 30px;
            border-radius: 15px;
            overflow: hidden;
            margin: 15px 0;
            position: relative;
        }

        .progress-fill {
            background: linear-gradient(90deg, #00a651, #00d163);
            height: 100%;
            transition: width 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
        }

        .stats {
            display: flex;
            justify-content: space-around;
            margin-top: 15px;
        }

        .stat {
            text-align: center;
        }

        .stat-value {
            font-size: 28px;
            font-weight: 700;
            color: #00a651;
        }

        .stat-label {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }

        .card {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .query-block {
            background: #f0f4ff;
            padding: 15px 20px;
            border-radius: 8px;
            border-left: 4px solid #667eea;
            margin-bottom: 25px;
        }

        .query-text {
            font-size: 20px;
            font-weight: 600;
            color: #333;
        }

        .query-meta {
            font-size: 14px;
            color: #666;
            margin-top: 5px;
        }

        .news-item {
            padding: 20px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            margin-bottom: 20px;
            transition: all 0.2s;
        }

        .news-item:hover {
            border-color: #667eea;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.2);
        }

        .news-title {
            font-size: 18px;
            font-weight: 600;
            color: #333;
            margin-bottom: 10px;
        }

        .news-description {
            font-size: 14px;
            color: #666;
            line-height: 1.6;
            margin-bottom: 15px;
        }

        .news-meta {
            display: flex;
            gap: 15px;
            font-size: 13px;
            color: #999;
            margin-bottom: 15px;
        }

        .features {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin-bottom: 20px;
            padding: 15px;
            background: #f9f9f9;
            border-radius: 6px;
        }

        .feature {
            font-size: 12px;
        }

        .feature-name {
            color: #666;
        }

        .feature-value {
            font-weight: 600;
            color: #333;
        }

        .rating-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
        }

        .rating-btn {
            flex: 1;
            padding: 15px;
            border: 2px solid #e0e0e0;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.2s;
            position: relative;
        }

        .rating-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .rating-btn.selected {
            border-color: #00a651;
            background: #00a651;
            color: white;
        }

        .rating-btn.level-0 { border-color: #ef4444; }
        .rating-btn.level-0.selected { background: #ef4444; border-color: #ef4444; }

        .rating-btn.level-1 { border-color: #f59e0b; }
        .rating-btn.level-1.selected { background: #f59e0b; border-color: #f59e0b; }

        .rating-btn.level-2 { border-color: #10b981; }
        .rating-btn.level-2.selected { background: #10b981; border-color: #10b981; }

        .rating-btn.level-3 { border-color: #3b82f6; }
        .rating-btn.level-3.selected { background: #3b82f6; border-color: #3b82f6; }

        .hotkey {
            position: absolute;
            top: 5px;
            right: 5px;
            font-size: 11px;
            background: #f0f0f0;
            padding: 2px 6px;
            border-radius: 3px;
            color: #666;
        }

        .selected .hotkey {
            background: rgba(255,255,255,0.3);
            color: white;
        }

        .navigation {
            display: flex;
            justify-content: space-between;
            margin-top: 30px;
        }

        .nav-btn {
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .nav-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .nav-btn.prev {
            background: #6c757d;
            color: white;
        }

        .nav-btn.next {
            background: #00a651;
            color: white;
        }

        .nav-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }

        .actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .action-btn {
            padding: 10px 20px;
            border: 2px solid #667eea;
            background: white;
            color: #667eea;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
        }

        .action-btn:hover {
            background: #667eea;
            color: white;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }

        .empty-state h2 {
            font-size: 24px;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìä Learning to Rank - –ê–Ω–Ω–æ—Ç–∞—Ç–æ—Ä</h1>
            <div class="progress-bar">
                <div class="progress-fill" id="progress-bar" style="width: 0%">
                    <span id="progress-text">0%</span>
                </div>
            </div>
            <div class="stats">
                <div class="stat">
                    <div class="stat-value" id="stat-total">0</div>
                    <div class="stat-label">–í—Å–µ–≥–æ</div>
                </div>
                <div class="stat">
                    <div class="stat-value" id="stat-annotated">0</div>
                    <div class="stat-label">–†–∞–∑–º–µ—á–µ–Ω–æ</div>
                </div>
                <div class="stat">
                    <div class="stat-value" id="stat-remaining">0</div>
                    <div class="stat-label">–û—Å—Ç–∞–ª–æ—Å—å</div>
                </div>
            </div>
            <div class="actions">
                <button class="action-btn" onclick="loadDataset()">üìÇ –ó–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞—Ç–∞—Å–µ—Ç</button>
                <button class="action-btn" onclick="saveProgress()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å</button>
                <button class="action-btn" onclick="exportDataset()">üì• –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å CSV</button>
                <button class="action-btn" onclick="retrainModel()" style="background: #f59e0b;">üîÑ –ü–µ—Ä–µ–æ–±—É—á–∏—Ç—å –º–æ–¥–µ–ª—å</button>
            </div>
        </div>

        <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–µ—Ä–µ–æ–±—É—á–µ–Ω–∏—è -->
        <div id="retrain-results" class="card" style="display: none; background: #fef3c7; border: 2px solid #f59e0b;">
            <h3 style="margin-bottom: 15px; color: #92400e;">üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–µ—Ä–µ–æ–±—É—á–µ–Ω–∏—è</h3>
            <div id="retrain-message" style="margin-bottom: 20px; font-size: 15px;"></div>

            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 20px;">
                <div style="background: white; padding: 15px; border-radius: 8px;">
                    <div style="font-size: 24px; font-weight: bold; color: #3b82f6;" id="retrain-ndcg">-</div>
                    <div style="font-size: 13px; color: #666;">Validation NDCG</div>
                </div>
                <div style="background: white; padding: 15px; border-radius: 8px;">
                    <div style="font-size: 24px; font-weight: bold; color: #10b981;" id="retrain-samples">-</div>
                    <div style="font-size: 13px; color: #666;">–û–±—É—á–∞—é—â–∞—è –≤—ã–±–æ—Ä–∫–∞</div>
                </div>
                <div style="background: white; padding: 15px; border-radius: 8px;">
                    <div style="font-size: 24px; font-weight: bold; color: #8b5cf6;" id="retrain-queries">-</div>
                    <div style="font-size: 13px; color: #666;">–£–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤</div>
                </div>
            </div>

            <h4 style="margin-top: 20px; margin-bottom: 10px; color: #92400e;">–ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ –≤–∞–∂–Ω–æ—Å—Ç–∏ —Ñ–∏—á–µ–π:</h4>
            <div id="feature-changes" style="font-family: monospace; font-size: 13px;"></div>
        </div>

        <!-- –§–æ—Ä–º–∞ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Å–≤–æ–∏—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ -->
        <div class="card" style="background: #f0f9ff; border: 2px dashed #667eea;">
            <h3 style="margin-bottom: 15px; color: #667eea;">‚ûï –î–æ–±–∞–≤–∏—Ç—å —Å–≤–æ–π –∑–∞–ø—Ä–æ—Å</h3>
            <div style="display: flex; gap: 10px; align-items: flex-end;">
                <div style="flex: 1;">
                    <label style="font-size: 13px; color: #666; display: block; margin-bottom: 5px;">–í–≤–µ–¥–∏—Ç–µ –∑–∞–ø—Ä–æ—Å:</label>
                    <input type="text" id="custom-query" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –í–¢–ë –∏–ø–æ—Ç–µ–∫–∞"
                           style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 8px; font-size: 16px;">
                </div>
                <div style="width: 150px;">
                    <label style="font-size: 13px; color: #666; display: block; margin-bottom: 5px;">–ö–∞–Ω–¥–∏–¥–∞—Ç–æ–≤:</label>
                    <select id="custom-topk" style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 8px; font-size: 16px;">
                        <option value="10" selected>–¢–æ–ø-10</option>
                        <option value="15">–¢–æ–ø-15</option>
                        <option value="20">–¢–æ–ø-20</option>
                    </select>
                </div>
                <button class="action-btn" onclick="addCustomQuery()" style="background: #667eea;">üîç –ù–∞–π—Ç–∏ –∏ –¥–æ–±–∞–≤–∏—Ç—å</button>
            </div>
            <div id="custom-query-status" style="margin-top: 10px; font-size: 13px; color: #666;"></div>
        </div>

        <div class="card" id="annotation-card">
            <div class="empty-state">
                <h2>üéØ –ì–æ—Ç–æ–≤ –∫ —Ä–∞–∑–º–µ—Ç–∫–µ!</h2>
                <p>–ù–∞–∂–º–∏—Ç–µ "–ó–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞—Ç–∞—Å–µ—Ç" —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å</p>
            </div>
        </div>
    </div>

    <input type="file" id="file-input" accept=".json" style="display: none;">

    <script>
        let dataset = [];
        let currentIndex = 0;
        let annotations = {};

        // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞—Ç–∞—Å–µ—Ç–∞
        function loadDataset() {
            document.getElementById('file-input').click();
        }

        document.getElementById('file-input').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (event) => {
                try {
                    const loadedData = JSON.parse(event.target.result);

                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —É–∂–µ —Ä–∞–∑–º–µ—á–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –≤ —Ñ–∞–π–ª–µ
                    const hasLabels = loadedData.some(item => item.label !== null && item.label !== undefined);

                    if (hasLabels) {
                        // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ä–∞–∑–º–µ—á–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –Ω–∞–ø—Ä—è–º—É—é
                        dataset = loadedData;

                        // –°—á–∏—Ç–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
                        const labeledCount = dataset.filter(item => item.label !== null && item.label !== undefined).length;
                        const unlabeledCount = dataset.length - labeledCount;

                        // –ù–∞—Ö–æ–¥–∏–º –ø–µ—Ä–≤—ã–π –Ω–µ—Ä–∞–∑–º–µ—á–µ–Ω–Ω—ã–π —ç–ª–µ–º–µ–Ω—Ç
                        const firstUnlabeled = dataset.findIndex(item => item.label === null || item.label === undefined);
                        currentIndex = firstUnlabeled >= 0 ? firstUnlabeled : 0;

                        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ localStorage
                        localStorage.setItem('ltr_dataset', JSON.stringify(dataset));

                        console.log(`‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ ${dataset.length} –∑–∞–ø–∏—Å–µ–π (${labeledCount} —Ä–∞–∑–º–µ—á–µ–Ω–æ, ${unlabeledCount} –æ—Å—Ç–∞–ª–æ—Å—å)`);
                        alert(`–ó–∞–≥—Ä—É–∂–µ–Ω —Ä–∞–∑–º–µ—á–µ–Ω–Ω—ã–π –¥–∞—Ç–∞—Å–µ—Ç!\n\nüìä –í—Å–µ–≥–æ: ${dataset.length}\n‚úÖ –†–∞–∑–º–µ—á–µ–Ω–æ: ${labeledCount}\n‚è≥ –û—Å—Ç–∞–ª–æ—Å—å: ${unlabeledCount}\n\n–ü—Ä–æ–¥–æ–ª–∂–∏–º —Å –∑–∞–ø–∏—Å–∏ #${currentIndex + 1}`);
                    } else {
                        // –ó–∞–≥—Ä—É–∂–∞–µ–º –Ω–µ—Ä–∞–∑–º–µ—á–µ–Ω–Ω—ã–π –¥–∞—Ç–∞—Å–µ—Ç
                        dataset = loadedData;

                        // –ü—ã—Ç–∞–µ–º—Å—è –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–π –ø—Ä–æ–≥—Ä–µ—Å—Å –∏–∑ localStorage
                        const saved = localStorage.getItem('ltr_annotations');
                        if (saved) {
                            annotations = JSON.parse(saved);
                        }

                        currentIndex = 0;
                        console.log(`‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ ${dataset.length} –∑–∞–ø–∏—Å–µ–π (–Ω–µ—Ä–∞–∑–º–µ—á–µ–Ω–Ω—ã—Ö)`);
                    }

                    updateUI();
                    updateStats();
                } catch (err) {
                    alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞: ' + err.message);
                }
            };
            reader.readAsText(file);
        });

        // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
        function renderAnnotation() {
            if (!dataset.length) return;

            const item = dataset[currentIndex];
            const key = `${item.query}_${item.news_id}`;
            const currentLabel = annotations[key] !== undefined ? annotations[key] : item.label;

            let html = '';

            // –ë–ª–æ–∫ –∑–∞–ø—Ä–æ—Å–∞
            html += `<div class="query-block">`;
            html += `<div class="query-text">üîç ${item.query}</div>`;
            html += `<div class="query-meta">–ó–∞–ø—Ä–æ—Å ${currentIndex + 1} –∏–∑ ${dataset.length}</div>`;
            html += `</div>`;

            // –ù–æ–≤–æ—Å—Ç—å
            html += `<div class="news-item">`;
            html += `<div class="news-title">${item.title}</div>`;
            if (item.description) {
                html += `<div class="news-description">${item.description}</div>`;
            }
            html += `<div class="news-meta">`;
            html += `<span>üì∞ ${item.source}</span>`;
            if (item.published) {
                html += `<span>üìÖ ${new Date(item.published).toLocaleDateString('ru-RU')}</span>`;
            }
            html += `<span>üî¢ –†–∞–Ω–≥: ${item.rank}</span>`;
            html += `</div>`;

            // –§–∏—á–∏
            html += `<div class="features">`;
            for (const [name, value] of Object.entries(item.features)) {
                const displayValue = typeof value === 'number' ? value.toFixed(3) : value;
                html += `<div class="feature">`;
                html += `<span class="feature-name">${name}:</span> `;
                html += `<span class="feature-value">${displayValue}</span>`;
                html += `</div>`;
            }
            html += `</div>`;

            // –ö–Ω–æ–ø–∫–∏ –æ—Ü–µ–Ω–∫–∏
            html += `<div class="rating-buttons">`;
            for (let i = 0; i <= 3; i++) {
                const labels = [
                    '‚ùå –ù–µ—Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–∞',
                    'ü§î –°–ª–∞–±–æ —Å–≤—è–∑–∞–Ω–∞',
                    '‚úÖ –†–µ–ª–µ–≤–∞–Ω—Ç–Ω–∞',
                    '‚≠ê –ò–¥–µ–∞–ª—å–Ω–æ'
                ];
                const selected = currentLabel === i ? 'selected' : '';
                html += `<button class="rating-btn level-${i} ${selected}" onclick="setRating(${i})">`;
                html += `<div class="hotkey">${i}</div>`;
                html += labels[i];
                html += `</button>`;
            }
            html += `</div>`;

            html += `</div>`;

            // –ù–∞–≤–∏–≥–∞—Ü–∏—è
            html += `<div class="navigation">`;
            html += `<button class="nav-btn prev" onclick="prevItem()" ${currentIndex === 0 ? 'disabled' : ''}>‚Üê –ù–∞–∑–∞–¥</button>`;
            html += `<button class="nav-btn next" onclick="nextItem()" ${currentIndex === dataset.length - 1 ? 'disabled' : ''}>–í–ø–µ—Ä–µ–¥ ‚Üí</button>`;
            html += `</div>`;

            document.getElementById('annotation-card').innerHTML = html;
        }

        // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –æ—Ü–µ–Ω–∫–∏
        function setRating(rating) {
            const item = dataset[currentIndex];
            const key = `${item.query}_${item.news_id}`;
            annotations[key] = rating;
            item.label = rating;

            // –ê–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ
            localStorage.setItem('ltr_annotations', JSON.stringify(annotations));

            updateUI();

            // –ê–≤—Ç–æ–ø–µ—Ä–µ—Ö–æ–¥ –∫ —Å–ª–µ–¥—É—é—â–µ–º—É
            setTimeout(() => {
                if (currentIndex < dataset.length - 1) {
                    nextItem();
                }
            }, 200);
        }

        // –ù–∞–≤–∏–≥–∞—Ü–∏—è
        function nextItem() {
            if (currentIndex < dataset.length - 1) {
                currentIndex++;
                updateUI();
            }
        }

        function prevItem() {
            if (currentIndex > 0) {
                currentIndex--;
                updateUI();
            }
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
        function updateUI() {
            renderAnnotation();
            updateStats();
        }

        function updateStats() {
            const total = dataset.length;

            // –ü–æ–¥—Å—á–µ—Ç —Ä–∞–∑–º–µ—á–µ–Ω–Ω—ã—Ö: –ø—Ä–æ–≤–µ—Ä—è–µ–º –∏ annotations, –∏ dataset[].label
            let annotated = 0;
            dataset.forEach((item, idx) => {
                const key = `${item.query}_${item.news_id}`;
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º: –ª–∏–±–æ –µ—Å—Ç—å –≤ annotations, –ª–∏–±–æ label –ø—Ä—è–º–æ –≤ dataset
                if (annotations[key] !== undefined || (item.label !== null && item.label !== undefined)) {
                    annotated++;
                }
            });

            const remaining = total - annotated;
            const progress = total > 0 ? (annotated / total * 100).toFixed(0) : 0;

            document.getElementById('stat-total').textContent = total;
            document.getElementById('stat-annotated').textContent = annotated;
            document.getElementById('stat-remaining').textContent = remaining;
            document.getElementById('progress-bar').style.width = progress + '%';
            document.getElementById('progress-text').textContent = progress + '%';
        }

        // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
        function saveProgress() {
            // –ü—Ä–∏–º–µ–Ω—è–µ–º –∞–Ω–Ω–æ—Ç–∞—Ü–∏–∏ –∫ –¥–∞—Ç–∞—Å–µ—Ç—É
            dataset.forEach(item => {
                const key = `${item.query}_${item.news_id}`;
                if (annotations[key] !== undefined) {
                    item.label = annotations[key];
                }
            });

            const blob = new Blob([JSON.stringify(dataset, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `ltr_dataset_annotated_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);

            console.log('‚úÖ –ü—Ä–æ–≥—Ä–µ—Å—Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω');
        }

        // –≠–∫—Å–ø–æ—Ä—Ç –≤ CSV
        function exportDataset() {
            // –ü—Ä–∏–º–µ–Ω—è–µ–º –∞–Ω–Ω–æ—Ç–∞—Ü–∏–∏
            dataset.forEach(item => {
                const key = `${item.query}_${item.news_id}`;
                if (annotations[key] !== undefined) {
                    item.label = annotations[key];
                }
            });

            // –°–æ–∑–¥–∞–µ–º CSV
            let csv = 'query,news_id,label,';
            const features = Object.keys(dataset[0].features);
            csv += features.join(',') + '\n';

            dataset.forEach(item => {
                if (item.label === null || item.label === undefined) return; // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –Ω–µ—Ä–∞–∑–º–µ—á–µ–Ω–Ω—ã–µ

                csv += `"${item.query}",${item.news_id},${item.label},`;
                csv += features.map(f => item.features[f]).join(',') + '\n';
            });

            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `ltr_dataset_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            URL.revokeObjectURL(url);

            console.log('‚úÖ –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ –≤ CSV');
        }

        // –ì–æ—Ä—è—á–∏–µ –∫–ª–∞–≤–∏—à–∏
        document.addEventListener('keydown', (e) => {
            if (!dataset.length) return;

            // 0-3: –æ—Ü–µ–Ω–∫–∏
            if (e.key >= '0' && e.key <= '3') {
                setRating(parseInt(e.key));
            }
            // –°—Ç—Ä–µ–ª–∫–∏: –Ω–∞–≤–∏–≥–∞—Ü–∏—è
            else if (e.key === 'ArrowLeft') {
                prevItem();
            }
            else if (e.key === 'ArrowRight') {
                nextItem();
            }
            // S: —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å
            else if (e.key === 's' && (e.ctrlKey || e.metaKey)) {
                e.preventDefault();
                saveProgress();
            }
        });

        // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞ —á–µ—Ä–µ–∑ API
        async function addCustomQuery() {
            const query = document.getElementById('custom-query').value.trim();
            const topK = parseInt(document.getElementById('custom-topk').value);
            const statusEl = document.getElementById('custom-query-status');

            if (!query) {
                statusEl.textContent = '‚ùå –í–≤–µ–¥–∏—Ç–µ –∑–∞–ø—Ä–æ—Å';
                statusEl.style.color = '#e74c3c';
                return;
            }

            statusEl.textContent = '‚è≥ –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤...';
            statusEl.style.color = '#3498db';

            try {
                const response = await fetch('http://localhost:8001/api/ltr/generate_candidates', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        query: query,
                        top_k: topK
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }

                const data = await response.json();

                // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–µ –∫–∞–Ω–¥–∏–¥–∞—Ç—ã –≤ –¥–∞—Ç–∞—Å–µ—Ç
                dataset.push(...data.candidates);

                statusEl.textContent = `‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ ${data.total} –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤ –¥–ª—è "${query}"`;
                statusEl.style.color = '#27ae60';

                // –û—á–∏—â–∞–µ–º –ø–æ–ª–µ –≤–≤–æ–¥–∞
                document.getElementById('custom-query').value = '';

                // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
                updateStats();

                // –ï—Å–ª–∏ —ç—Ç–æ –ø–µ—Ä–≤—ã–π –∑–∞–ø—Ä–æ—Å - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
                if (dataset.length === data.total) {
                    updateUI();
                }

                // –ê–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ
                setTimeout(() => {
                    localStorage.setItem('ltr_dataset', JSON.stringify(dataset));
                }, 500);

            } catch (error) {
                statusEl.textContent = `‚ùå –û—à–∏–±–∫–∞: ${error.message}. –ó–∞–ø—É—Å—Ç–∏—Ç–µ —Å–µ—Ä–≤–∏—Å (python3 news_collector_service.py)`;
                statusEl.style.color = '#e74c3c';
                console.error('Error:', error);
            }
        }

        // –ü–µ—Ä–µ–æ–±—É—á–µ–Ω–∏–µ –º–æ–¥–µ–ª–∏
        async function retrainModel() {
            const resultsDiv = document.getElementById('retrain-results');
            const messageEl = document.getElementById('retrain-message');

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —Ä–∞–∑–º–µ—á–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
            const labeledData = dataset.filter(item => item.label !== null);

            if (labeledData.length < 10) {
                alert(`–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Ä–∞–∑–º–µ—á–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö: ${labeledData.length}. –ù—É–∂–Ω–æ –º–∏–Ω–∏–º—É–º 10 —Ä–∞–∑–º–µ—á–µ–Ω–Ω—ã—Ö –ø—Ä–∏–º–µ—Ä–æ–≤.`);
                return;
            }

            if (!confirm(`–ü–µ—Ä–µ–æ–±—É—á–∏—Ç—å –º–æ–¥–µ–ª—å –Ω–∞ ${labeledData.length} —Ä–∞–∑–º–µ—á–µ–Ω–Ω—ã—Ö –ø—Ä–∏–º–µ—Ä–∞—Ö?\n\n–≠—Ç–æ –∑–∞–π–º—ë—Ç 10-30 —Å–µ–∫—É–Ω–¥.`)) {
                return;
            }

            messageEl.textContent = '‚è≥ –ü–µ—Ä–µ–æ–±—É—á–µ–Ω–∏–µ –º–æ–¥–µ–ª–∏... –≠—Ç–æ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å 10-30 —Å–µ–∫—É–Ω–¥.';
            messageEl.style.color = '#92400e';
            resultsDiv.style.display = 'block';

            try {
                const response = await fetch('http://localhost:8001/api/ltr/retrain', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        dataset: dataset
                    })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || `HTTP ${response.status}`);
                }

                const result = await response.json();

                // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
                messageEl.textContent = `‚úÖ ${result.message}`;
                messageEl.style.color = '#15803d';

                // –ú–µ—Ç—Ä–∏–∫–∏
                document.getElementById('retrain-ndcg').textContent = result.metrics.val_ndcg.toFixed(4);
                document.getElementById('retrain-samples').textContent = result.metrics.n_train_samples;
                document.getElementById('retrain-queries').textContent = result.metrics.n_queries_total;

                // –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π —Ñ–∏—á–µ–π
                const changesDiv = document.getElementById('feature-changes');
                changesDiv.innerHTML = '';

                // –°–æ—Ä—Ç–∏—Ä—É–µ–º —Ñ–∏—á–∏ –ø–æ –∞–±—Å–æ–ª—é—Ç–Ω–æ–º—É –∏–∑–º–µ–Ω–µ–Ω–∏—é
                const sortedFeatures = Object.entries(result.changes)
                    .sort((a, b) => Math.abs(b[1].delta) - Math.abs(a[1].delta));

                sortedFeatures.forEach(([feature, change]) => {
                    const row = document.createElement('div');
                    row.style.padding = '8px';
                    row.style.borderBottom = '1px solid #e5e7eb';
                    row.style.display = 'grid';
                    row.style.gridTemplateColumns = '2fr 1fr 1fr 1fr';
                    row.style.alignItems = 'center';
                    row.style.gap = '10px';

                    const isIncrease = change.delta > 0;
                    const deltaColor = isIncrease ? '#10b981' : '#ef4444';
                    const arrow = isIncrease ? '‚Üë' : '‚Üì';

                    row.innerHTML = `
                        <div style="font-weight: 600;">${feature}</div>
                        <div style="color: #666;">${change.old.toFixed(0)} ‚Üí ${change.new.toFixed(0)}</div>
                        <div style="color: ${deltaColor}; font-weight: bold;">${arrow} ${Math.abs(change.delta).toFixed(0)}</div>
                        <div style="color: ${deltaColor}; font-size: 12px;">(${change.delta_percent > 0 ? '+' : ''}${change.delta_percent.toFixed(1)}%)</div>
                    `;

                    changesDiv.appendChild(row);
                });

                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –±—ç–∫–∞–ø–µ
                console.log(`–°—Ç–∞—Ä–∞—è –º–æ–¥–µ–ª—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞ –∫–∞–∫: ${result.backup_file}`);

            } catch (error) {
                messageEl.textContent = `‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–µ—Ä–µ–æ–±—É—á–µ–Ω–∏–∏: ${error.message}`;
                messageEl.style.color = '#dc2626';
                console.error('Retrain error:', error);
            }
        }

        // –ü–æ–¥–¥–µ—Ä–∂–∫–∞ Enter –≤ –ø–æ–ª–µ –∑–∞–ø—Ä–æ—Å–∞
        document.addEventListener('DOMContentLoaded', () => {
            const queryInput = document.getElementById('custom-query');
            if (queryInput) {
                queryInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        addCustomQuery();
                    }
                });
            }
        });

        // –ê–≤—Ç–æ–∑–∞–≥—Ä—É–∑–∫–∞ –∏–∑ localStorage –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ
        window.addEventListener('load', () => {
            updateStats();
        });
    </script>
</body>
</html>
